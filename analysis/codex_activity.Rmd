---
title: "On-Sale Liquor Licenses: Codex Activity"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

## Research Question

In this short analysis, we investigate:

- How the proportions of on-sale liquor license statuses (Approved, Pending, and other statuses) vary across Minneapolis neighborhoods and wards in the most recent year of data.

## Load Packages and Data

```{r libraries-and-data}
# Load core tidyverse for data wrangling and plotting
library(tidyverse)

# lubridate helps with parsing and working with dates
library(lubridate)

# Read the liquor license data from the data folder
liquor <- read_csv("../data/On_Sale_Liquor.csv", show_col_types = FALSE)
```

## Basic Structure and Missingness

```{r structure}
# Inspect the overall structure: rows, columns, and types
glimpse(liquor)

# Quick summaries of each variable
summary(liquor)
```

```{r missingness}
# Count missing values per column
missing_summary <- liquor %>%
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  pivot_longer(
    cols = everything(),
    names_to = "variable",
    values_to = "n_missing"
  ) %>%
  arrange(desc(n_missing))

missing_summary
```

## Prepare Variables for Analysis

```{r prepare}
liquor <- liquor %>%
  mutate(
    # Parse key date columns; invalid or missing values become NA
    issueDate      = ymd_hms(issueDate, quiet = TRUE),
    expirationDate = ymd_hms(expirationDate, quiet = TRUE),
    lastUpdateDate = ymd_hms(lastUpdateDate, quiet = TRUE),
    # Treat missing categorical values explicitly as "Unknown"
    licenseStatus  = fct_explicit_na(licenseStatus, na_level = "Unknown"),
    licenseType    = fct_explicit_na(licenseType, na_level = "Unknown"),
    neighborhood   = fct_explicit_na(neighborhood, na_level = "Unknown")
  )
```

## License Status by Neighborhood and Ward

```{r status-by-neighborhood}
# Proportions of license statuses by neighborhood
status_by_neighborhood <- liquor %>%
  group_by(neighborhood, licenseStatus) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  mutate(prop = n / sum(n))

status_by_neighborhood
```

```{r plot-status-neighborhood, fig.height=6, fig.width=8}
# Plot the distribution of statuses for the top 10 neighborhoods by total licenses
top_neighborhoods <- liquor %>%
  count(neighborhood, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(neighborhood)

status_by_neighborhood %>%
  filter(neighborhood %in% top_neighborhoods) %>%
  ggplot(aes(x = neighborhood, y = prop, fill = licenseStatus)) +
  geom_col(position = "fill") +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Proportion of License Statuses by Neighborhood (Top 10)",
    x = "Neighborhood",
    y = "Proportion of Licenses",
    fill = "License Status"
  ) +
  theme_minimal()
```

```{r status-by-ward}
# Proportions of license statuses by ward
status_by_ward <- liquor %>%
  group_by(ward, licenseStatus) %>%
  summarise(n = n(), .groups = "drop_last") %>%
  mutate(prop = n / sum(n))

status_by_ward
```

```{r plot-status-ward, fig.height=4, fig.width=7}
status_by_ward %>%
  ggplot(aes(x = factor(ward), y = prop, fill = licenseStatus)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Proportion of License Statuses by Ward",
    x = "Ward",
    y = "Proportion of Licenses",
    fill = "License Status"
  ) +
  theme_minimal()
```

## Additional Descriptive Visualizations

```{r licenses-by-type, fig.height=4, fig.width=7}
# Distribution of licenses by license type
liquor %>%
  count(licenseType, sort = TRUE) %>%
  mutate(licenseType = fct_reorder(licenseType, n)) %>%
  ggplot(aes(x = licenseType, y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "On-Sale Liquor Licenses by License Type",
    x = "License Type",
    y = "Number of Licenses"
  ) +
  theme_minimal()
```

```{r licenses-by-year, fig.height=4, fig.width=7}
# New licenses over time (by issue year), excluding missing dates
liquor %>%
  filter(!is.na(issueDate)) %>%
  mutate(issue_year = year(issueDate)) %>%
  count(issue_year) %>%
  ggplot(aes(x = issue_year, y = n)) +
  geom_col(fill = "darkorange") +
  labs(
    title = "New On-Sale Liquor Licenses by Issue Year",
    x = "Issue Year",
    y = "Number of New Licenses"
  ) +
  theme_minimal()
```

## Mapping the Licenses

```{r map-basic, fig.height=6, fig.width=6}
# Basic point map of licenses using latitude and longitude
liquor_points <- liquor %>%
  filter(!is.na(lat), !is.na(long))

ggplot(liquor_points, aes(x = long, y = lat)) +
  geom_point(alpha = 0.6, size = 1.8, color = "steelblue") +
  coord_quickmap() +
  labs(
    title = "On-Sale Liquor Licenses in Minneapolis",
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal()
```

```{r map-by-status, fig.height=6, fig.width=6}
# Map colored by license status to highlight spatial patterns
ggplot(liquor_points, aes(x = long, y = lat, color = licenseStatus)) +
  geom_point(alpha = 0.7, size = 1.8) +
  coord_quickmap() +
  labs(
    title = "On-Sale Liquor Licenses by Status",
    x = "Longitude",
    y = "Latitude",
    color = "License Status"
  ) +
  theme_minimal()
```


## One shot code from Codex
```{r}
# Quick one-shot summary of Pending share by neighborhood
# Note: path is relative to the analysis/ folder
read_csv("../data/On_Sale_Liquor.csv", show_col_types = FALSE) %>%
  mutate(
    licenseStatus = fct_explicit_na(licenseStatus, na_level = "Unknown"),
    neighborhood  = fct_explicit_na(neighborhood,  na_level = "Unknown")
  ) %>%
  group_by(neighborhood) %>%
  summarise(
    total_licenses   = n(),
    pending_licenses = sum(licenseStatus == "Pending"),
    pending_share    = pending_licenses / total_licenses,
    .groups = "drop"
  ) %>%
  # Optional: focus on neighborhoods with at least 5 licenses
  filter(total_licenses >= 5) %>%
  arrange(desc(pending_share))

```

## Detailed analysis: Pending share by neighborhood

### Step one, define scope and “unusually high”
```{r pending-scope}
# Create an issue year variable from the parsed issueDate
liquor <- liquor %>%
  mutate(issue_year = year(issueDate))

# Inspect how many licenses we have by year
issue_year_counts <- liquor %>%
  count(issue_year)

issue_year_counts

# Identify the most recent year with data
most_recent_year <- issue_year_counts %>%
  filter(!is.na(issue_year)) %>%
  summarise(most_recent_year = max(issue_year)) %>%
  pull(most_recent_year)

most_recent_year
```

### Step 2: Clean and prepare the data
```{r pending-prepare}
# Restrict to licenses issued in the most recent year
# and drop Unknown neighborhoods for this neighborhood-level question
liquor_recent <- liquor %>%
  filter(issue_year == most_recent_year) %>%
  filter(neighborhood != "Unknown")

glimpse(liquor_recent)
```

### Step 3: Compute neighborhood-level Pending shares
```{r pending-citywide}
# Citywide Pending share in the most recent year
citywide_pending <- liquor_recent %>%
  summarise(
    total_licenses   = n(),
    pending_licenses = sum(licenseStatus == "Pending", na.rm = TRUE),
    pending_share    = pending_licenses / total_licenses
  )

citywide_pending

citywide_share <- citywide_pending$pending_share
```

```{r pending-neighborhood}
# Neighborhood-level totals and Pending shares,
# keeping only neighborhoods with at least 5 licenses
neighborhood_pending <- liquor_recent %>%
  group_by(neighborhood) %>%
  summarise(
    total_licenses   = n(),
    pending_licenses = sum(licenseStatus == "Pending", na.rm = TRUE),
    pending_share    = pending_licenses / total_licenses,
    .groups = "drop"
  ) %>%
  filter(total_licenses >= 5)

neighborhood_pending
```

### Step 4: Identify and visualize “high-pending” neighborhoods
```{r pending-visual, fig.height=5, fig.width=8}
# Flag neighborhoods where Pending share is above the citywide share
high_pending_neighborhoods <- neighborhood_pending %>%
  mutate(
    above_citywide = pending_share > citywide_share,
    diff_from_city = pending_share - citywide_share
  ) %>%
  arrange(desc(pending_share))

high_pending_neighborhoods

# Visualize Pending share by neighborhood,
# highlighting those above the citywide share
neighborhood_pending %>%
  mutate(
    neighborhood   = fct_reorder(neighborhood, pending_share),
    above_citywide = pending_share > citywide_share
  ) %>%
  ggplot(aes(x = neighborhood, y = pending_share, fill = above_citywide)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(
    values = c("FALSE" = "grey70", "TRUE" = "tomato"),
    name   = "Above citywide\nPending share?"
  ) +
  labs(
    title = paste0(
      "Pending License Share by Neighborhood (", most_recent_year, ")"
    ),
    subtitle = paste0(
      "Citywide Pending share = ",
      scales::percent(citywide_share, accuracy = 0.1)
    ),
    x = "Neighborhood",
    y = "Pending share of licenses"
  ) +
  theme_minimal()
```

### Step 5: Interpret and report findings (code-supported)
```{r pending-top-neighborhoods}
# Table of the top neighborhoods by Pending share
top_high_pending <- high_pending_neighborhoods %>%
  slice_max(order_by = pending_share, n = 10)

top_high_pending
```





